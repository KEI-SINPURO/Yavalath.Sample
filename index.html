// ã‚²ãƒ¼ãƒ çŠ¶æ…‹
let currentPlayer = 'white';
let gameOver = false;
let board = {};

// ãƒœãƒ¼ãƒ‰ã®æ§‹é€ ï¼ˆå…­è§’å½¢ã‚°ãƒªãƒƒãƒ‰ï¼‰
const boardStructure = [
    [null, null, null, null, 0, 1, 2, 3, 4],
    [null, null, null, 5, 6, 7, 8, 9, 10],
    [null, null, 11, 12, 13, 14, 15, 16, 17],
    [null, 18, 19, 20, 21, 22, 23, 24, 25],
    [26, 27, 28, 29, 30, 31, 32, 33, 34],
    [35, 36, 37, 38, 39, 40, 41, 42, null],
    [43, 44, 45, 46, 47, 48, 49, null, null],
    [50, 51, 52, 53, 54, 55, null, null, null],
    [56, 57, 58, 59, 60, null, null, null, null]
];

// åº§æ¨™ã‹ã‚‰ã‚»ãƒ«IDã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
const coordToId = {};
for (let row = 0; row < boardStructure.length; row++) {
    for (let col = 0; col < boardStructure[row].length; col++) {
        const id = boardStructure[row][col];
        if (id !== null) {
            coordToId[`${row},${col}`] = id;
        }
    }
}

// IDã‹ã‚‰åº§æ¨™ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
const idToCoord = {};
for (let key in coordToId) {
    idToCoord[coordToId[key]] = key;
}

// ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–
function initBoard() {
    const boardElement = document.getElementById('board');
    boardElement.innerHTML = '';
    board = {};
    
    boardStructure.forEach((row, rowIndex) => {
        const rowElement = document.createElement('div');
        rowElement.className = 'hex-row';
        
        row.forEach((cellId, colIndex) => {
            if (cellId !== null) {
                const hexElement = document.createElement('div');
                hexElement.className = 'hex';
                hexElement.dataset.id = cellId;
                
                const hexInner = document.createElement('div');
                hexInner.className = 'hex-inner';
                
                hexElement.appendChild(hexInner);
                hexElement.addEventListener('click', () => placeStone(cellId));
                
                rowElement.appendChild(hexElement);
                board[cellId] = null;
            } else {
                const spacer = document.createElement('div');
                spacer.className = 'hex';
                spacer.style.visibility = 'hidden';
                rowElement.appendChild(spacer);
            }
        });
        
        boardElement.appendChild(rowElement);
    });
}

// çŸ³ã‚’ç½®ã
function placeStone(cellId) {
    if (gameOver || board[cellId] !== null) return;
    
    board[cellId] = currentPlayer;
    
    const hexElement = document.querySelector(`[data-id="${cellId}"]`);
    hexElement.classList.add('placed');
    
    const stone = document.createElement('div');
    stone.className = `stone ${currentPlayer}`;
    hexElement.appendChild(stone);
    
    // å‹æ•—åˆ¤å®š
    if (checkLose(cellId, currentPlayer)) {
        const winnerEmoji = currentPlayer === 'white' ? 'âš«' : 'âšª';
        const loserEmoji = currentPlayer === 'white' ? 'âšª' : 'âš«';
        endGame(`${loserEmoji} ${currentPlayer === 'white' ? 'ç™½' : 'é»’'}ãŒ3ã¤ä¸¦ã‚“ã ãŸã‚ã€${winnerEmoji} ${currentPlayer === 'white' ? 'é»’' : 'ç™½'}ã®å‹åˆ©ï¼ ğŸ‰`);
        return;
    }
    
    if (checkWin(cellId, currentPlayer)) {
        const emoji = currentPlayer === 'white' ? 'âšª' : 'âš«';
        endGame(`${emoji} ${currentPlayer === 'white' ? 'ç™½' : 'é»’'}ãŒ4ã¤ä¸¦ã‚“ã§å‹åˆ©ï¼ ğŸ†ğŸŠ`);
        return;
    }
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äº¤ä»£
    currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
    updatePlayerIndicator();
}

// 6æ–¹å‘ã®ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆå…­è§’å½¢ã‚°ãƒªãƒƒãƒ‰ç”¨ï¼‰
const directions = [
    [-1, 0],  // ä¸Š
    [1, 0],   // ä¸‹
    [0, -1],  // å·¦ä¸Š
    [0, 1],   // å³ä¸‹
    [-1, 1],  // å³ä¸Š
    [1, -1]   // å·¦ä¸‹
];

// æŒ‡å®šæ–¹å‘ã®é€£ç¶šæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
function countInDirection(cellId, player, rowDir, colDir) {
    const [row, col] = idToCoord[cellId].split(',').map(Number);
    let count = 0;
    let r = row + rowDir;
    let c = col + colDir;
    
    while (true) {
        const nextId = coordToId[`${r},${c}`];
        if (nextId === undefined || board[nextId] !== player) break;
        count++;
        r += rowDir;
        c += colDir;
    }
    
    return count;
}

// å‹åˆ©åˆ¤å®šï¼ˆ4ã¤ä¸¦ã³ï¼‰
function checkWin(cellId, player) {
    for (const [rowDir, colDir] of directions) {
        const forward = countInDirection(cellId, player, rowDir, colDir);
        const backward = countInDirection(cellId, player, -rowDir, -colDir);
        const total = forward + backward + 1;
        
        if (total >= 4) return true;
    }
    return false;
}

// æ•—åŒ—åˆ¤å®šï¼ˆ3ã¤ä¸¦ã³ï¼‰
function checkLose(cellId, player) {
    for (const [rowDir, colDir] of directions) {
        const forward = countInDirection(cellId, player, rowDir, colDir);
        const backward = countInDirection(cellId, player, -rowDir, -colDir);
        const total = forward + backward + 1;
        
        if (total === 3) return true;
    }
    return false;
}

// ã‚²ãƒ¼ãƒ çµ‚äº†
function endGame(message) {
    gameOver = true;
    document.getElementById('game-status').textContent = message;
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
function updatePlayerIndicator() {
    const indicator = document.getElementById('player-indicator');
    indicator.textContent = currentPlayer === 'white' ? 'âšª ç™½' : 'âš« é»’';
}

// ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetGame() {
    currentPlayer = 'white';
    gameOver = false;
    document.getElementById('game-status').textContent = '';
    updatePlayerIndicator();
    initBoard();
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    initBoard();
    updatePlayerIndicator();
    document.getElementById('reset-btn').addEventListener('click', resetGame);
});
